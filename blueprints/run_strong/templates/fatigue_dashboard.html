<!DOCTYPE html>
<html lang="en" class="runstrong">

<head>
    <meta charset="UTF-8" />
    <title>Fatigue Dashboard | RUNSTRONG</title>
    <link rel="stylesheet" href="{{ url_for('run_strong.static', filename='css/styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="runstrong">
    <div class="runstrong-navbar">
        <a href="{{ url_for('run_strong.runstrong') }}">Home</a>
        <a href="{{ url_for('run_strong.exercise_library') }}">Exercise Library</a>
        <a href="{{ url_for('run_strong.journal') }}" class="active">Workout Journal</a>
        <a href="{{ url_for('run_strong.fatigue_dashboard') }}">Fatigue Dashboard</a>
        <a href="{{ url_for('run_strong.goals') }}">Goals Dashboard</a>
    </div>

    <div class="runstrong-header">
        <h1>
            <a href="{{ url_for('running_hub.home') }}">Fatigue Dashboard ðŸ”‹</a>
        </h1>
    </div>
    <div id="category-toggle">
        <button data-category="overall" class="active">Overall</button>
        <button data-category="upper_body">Upper Body</button>
        <button data-category="lower_body">Lower Body</button>
        <button data-category="core">Core</button>
    </div>

    <div class="dashboard-grid">

        <div class="dashboard-card">
            <h3>Summary Score</h3>
            {% for category, details in data.items() %}
            <div data-category-view="{{ category }}" class="{{ 'hidden' if not loop.first }}">
                <div class="circular-meter">
                    <svg viewBox="0 0 36 36" class="circular-chart pink">
                        <path class="circle-bg" d="M18 2.0845
                                     a 15.9155 15.9155 0 0 1 0 31.831
                                     a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" stroke-dasharray="{{ " %.1f"|format(details.summary_score) }}, 100" d="M18 2.0845
                                     a 15.9155 15.9155 0 0 1 0 31.831
                                     a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <text x="18" y="20.35" class="percentage">{{ "%.0f"|format(details.summary_score) }}%</text>
                    </svg>
                </div>
                <p style="text-align: center;"><strong>{{ "%.0f"|format(details.summary_score) }} / 100</strong></p>
                <p><em>{{ details.interpretation }}</em></p>
            </div>
            {% endfor %}
        </div>

        <div class="dashboard-card">
            <h3>Recent 7-Day Workload</h3>
            {% for category, details in data.items() %}
            <div data-category-view="{{ category }}" class="{{ 'hidden' if not loop.first }}">
                <canvas id="chart-{{ category }}"></canvas>
            </div>
            {% endfor %}
        </div>

        <div class="dashboard-card">
            <h3>Most Fatigued Muscles</h3>
            {% for category, details in data.items() %}
            <div data-category-view="{{ category }}" class="{{ 'hidden' if not loop.first }}">
                <ul class="fatigue-list">
                    {% for muscle in details.top_5_fatigued %}
                    <li class="fatigue-score" style="--score: {{ " %.0f"|format(muscle.score) }}">
                        <span>{{ muscle.name }}</span>
                        <strong>{{ "%.0f"|format(muscle.score) }}</strong>
                    </li>
                    {% else %}<li>No data.</li>{% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>

        <div class="dashboard-card">
            <h3>Least Fatigued Muscles</h3>
            {% for category, details in data.items() %}
            <div data-category-view="{{ category }}" class="{{ 'hidden' if not loop.first }}">
                <ul class="fatigue-list">
                    {% for muscle in details.least_5_fatigued %}
                    <li class="fatigue-score" style="--score: {{ " %.0f"|format(muscle.score) }}">
                        <span>{{ muscle.name }}</span>
                        <strong>{{ "%.0f"|format(muscle.score) }}</strong>
                    </li>
                    {% else %}<li>No data.</li>{% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>

    </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toggleContainer = document.getElementById('category-toggle');
            const views = document.querySelectorAll('[data-category-view]');

            toggleContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const category = e.target.dataset.category;

                    // Update active button
                    toggleContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    // Show/hide relevant views
                    views.forEach(view => {
                        if (view.dataset.categoryView === category) {
                            view.classList.remove('hidden');
                        } else {
                            view.classList.add('hidden');
                        }
                    });
                }
            });

        // Render workload charts
        {% for category, details in data.items() %}
            // FIX: The entire declaration is on one line
            const ctx_{{ category }} = document.getElementById('chart-{{ category }}');
            
            // FIX: Removed the space inside the variable name
            if (ctx_{{ category }}) {
                new Chart(ctx_{{ category }}, {
                    type: 'line',
                    data: {
                        // FIX: Removed the space before the data
                        labels: {{ details.seven_day_workload | map(attribute='day') | list | tojson }},
                        datasets: [{
                            label: 'Workload (units)',
                            data: {{ details.seven_day_workload | map(attribute='workload') | list | tojson }},
                            backgroundColor: 'rgba(255, 78, 199, 0.2)',
                            borderColor: 'rgba(255, 78, 199, 1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            tension: 0.3
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        {% endfor %}
    });
</script>
</body>

</html>