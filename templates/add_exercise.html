<!DOCTYPE html>
<html lang="en" class="runstrong">

<head>
    <meta charset="UTF-8" />
    <title>Add Exercise | RUNSTRONG</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        function addTagInput(sectionId, inputName) {
            const section = document.getElementById(sectionId);
            const newInput = document.createElement("input");
            newInput.type = "text";
            newInput.name = inputName;
            newInput.classList.add("tag-input");
            section.appendChild(newInput);
        }

        function gatherFormData() {
            const form = document.getElementById("exercise-form");
            const data = {};

            new FormData(form).forEach((value, key) => {
                // Handle multiple input fields with the same name (tags)
                if (key.endsWith("[]")) {
                    const realKey = key.slice(0, -2);
                    data[realKey] = data[realKey] || [];
                    if (value.trim() !== "") data[realKey].push(value.trim());
                } else {
                    data[key] = value.trim() === "" ? null : value.trim();
                }
            });

            // JSON encode fields expected to be arrays
            const arrayFields = [
                'primary_muscles', 'secondary_muscles', 'progressions', 'regressions',
                'equipment_required', 'common_mistakes', 'training_style',
                'experience_level', 'goals', 'alternatives', 'supersets_well_with'
            ];
            arrayFields.forEach(field => {
                if (data[field]) {
                    data[field] = JSON.stringify(data[field]);
                } else {
                    data[field] = JSON.stringify([]);
                }
            });

            return data;
        }

        async function submitExerciseForm(event) {
            event.preventDefault();
            const form = event.target;
            const data = gatherFormData();

            try {
                const response = await fetch(form.action, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                const statusDiv = document.getElementById("form-status");
                if (response.ok) {
                    form.reset();
                    statusDiv.innerText = "Exercise added successfully!";
                    statusDiv.style.color = "lime";
                } else {
                    statusDiv.innerText = result.error || "Failed to add exercise.";
                    statusDiv.style.color = "red";
                }
            } catch (error) {
                console.error("Submission error:", error);
                document.getElementById("form-status").innerText = "Submission error.";
            }
        }
    </script>
</head>

<body class="runstrong">

    <div class="runstrong-navbar">
        <a href="{{ url_for('runstrong') }}">Home</a>
        <a href="{{ url_for('exercise_library') }}">Library</a>
        <a href="{{ url_for('planner') }}">Routines</a>
        <a href="{{ url_for('add_exercise') }}">Add</a>
        <a href="{{ url_for('journal') }}">Journal</a>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
    </div>

    <div class="runnervision-header">
        <a href="{{ url_for('home') }}">
            <img src="{{ url_for('static', filename='images/RUN_STRONG_logo_transparent.png') }}" alt="RunStrong Logo"
                class="runstrong-logo" />
        </a>
    </div>

    <div class="runstrong-container">
        <h2>Add New Exercise</h2>
        <form id="exercise-form" action="{{ url_for('add_exercise') }}" method="POST"
            onsubmit="submitExerciseForm(event)">
            <div class="form-section">
                <label>Name:</label>
                <input type="text" name="name" required>
            </div>

            <div class="form-section">
                <label>Description:</label>
                <textarea name="description"></textarea>
            </div>

            <div class="form-section">
                <label>Instructions:</label>
                <textarea name="instructions"></textarea>
            </div>

            <div class="form-section">
                <label>Exercise Type:</label>
                <input type="text" name="exercise_type">
            </div>

            <div class="form-section">
                <label>Movement Pattern:</label>
                <input type="text" name="movement_pattern">
            </div>

            <div class="form-section" id="primary-muscles">
                <label>Primary Muscles:</label>
                <input type="text" name="primary_muscles[]">
                <button type="button" onclick="addTagInput('primary-muscles', 'primary_muscles[]')">+ Add</button>
            </div>

            <div class="form-section" id="secondary-muscles">
                <label>Secondary Muscles:</label>
                <input type="text" name="secondary_muscles[]">
                <button type="button" onclick="addTagInput('secondary-muscles', 'secondary_muscles[]')">+ Add</button>
            </div>

            <div class="form-section">
                <label>Muscle Groups:</label>
                <input type="text" name="muscle_groups">
            </div>

            <div class="form-section">
                <label>Unilateral:</label>
                <select name="unilateral">
                    <option value="">Select</option>
                    <option value="True">Yes</option>
                    <option value="False">No</option>
                </select>
            </div>

            <div class="form-section">
                <label>Difficulty Rating (1â€“5):</label>
                <input type="number" name="difficulty_rating" min="1" max="5">
            </div>

            <div class="form-section">
                <label>Prerequisites:</label>
                <input type="text" name="prerequisites">
            </div>

            <div class="form-section" id="progressions">
                <label>Progressions:</label>
                <input type="text" name="progressions[]">
                <button type="button" onclick="addTagInput('progressions', 'progressions[]')">+ Add</button>
            </div>

            <div class="form-section" id="regressions">
                <label>Regressions:</label>
                <input type="text" name="regressions[]">
                <button type="button" onclick="addTagInput('regressions', 'regressions[]')">+ Add</button>
            </div>

            <div class="form-section" id="equipment-required">
                <label>Equipment Required:</label>
                <input type="text" name="equipment_required[]">
                <button type="button" onclick="addTagInput('equipment-required', 'equipment_required[]')">+ Add</button>
            </div>

            <div class="form-section">
                <label>Equipment Optional:</label>
                <input type="text" name="equipment_optional">
            </div>

            <div class="form-section">
                <label>Setup Time:</label>
                <input type="text" name="setup_time">
            </div>

            <div class="form-section">
                <label>Space Required:</label>
                <input type="text" name="space_required">
            </div>

            <div class="form-section">
                <label>Rep Range (Min - Max):</label>
                <input type="number" name="rep_range_min" placeholder="Min">
                <input type="number" name="rep_range_max" placeholder="Max">
            </div>

            <div class="form-section">
                <label>Tempo:</label>
                <input type="text" name="tempo">
            </div>

            <div class="form-section">
                <label>Range of Motion:</label>
                <input type="text" name="range_of_motion">
            </div>

            <div class="form-section">
                <label>Compound vs Isolation:</label>
                <input type="text" name="compound_vs_isolation">
            </div>

            <div class="form-section">
                <label>Injury Risk Level:</label>
                <input type="text" name="injury_risk_level">
            </div>

            <div class="form-section">
                <label>Contraindications:</label>
                <input type="text" name="contraindications">
            </div>

            <div class="form-section" id="common-mistakes">
                <label>Common Mistakes:</label>
                <input type="text" name="common_mistakes[]">
                <button type="button" onclick="addTagInput('common-mistakes', 'common_mistakes[]')">+ Add</button>
            </div>

            <div class="form-section">
                <label>Safety Notes:</label>
                <textarea name="safety_notes"></textarea>
            </div>

            <div class="form-section">
                <label>Image URL:</label>
                <input type="text" name="image_url">
            </div>

            <div class="form-section">
                <label>Video URL:</label>
                <input type="text" name="video_url">
            </div>

            <div class="form-section">
                <label>GIF URL:</label>
                <input type="text" name="gif_url">
            </div>

            <div class="form-section">
                <label>Diagram URL:</label>
                <input type="text" name="diagram_url">
            </div>

            <div class="form-section">
                <label>Category:</label>
                <input type="text" name="category">
            </div>

            <div class="form-section" id="training-style">
                <label>Training Style:</label>
                <input type="text" name="training_style[]">
                <button type="button" onclick="addTagInput('training-style', 'training_style[]')">+ Add</button>
            </div>

            <div class="form-section" id="experience-level">
                <label>Experience Level:</label>
                <input type="text" name="experience_level[]">
                <button type="button" onclick="addTagInput('experience-level', 'experience_level[]')">+ Add</button>
            </div>

            <div class="form-section" id="goals">
                <label>Goals:</label>
                <input type="text" name="goals[]">
                <button type="button" onclick="addTagInput('goals', 'goals[]')">+ Add</button>
            </div>

            <div class="form-section">
                <label>Duration (minutes):</label>
                <input type="number" name="duration_minutes" min="1">
            </div>

            <div class="form-section">
                <label>Popularity Score:</label>
                <input type="number" name="popularity_score" step="0.1" min="0">
            </div>

            <div class="form-section" id="alternatives">
                <label>Alternatives:</label>
                <input type="text" name="alternatives[]">
                <button type="button" onclick="addTagInput('alternatives', 'alternatives[]')">+ Add</button>
            </div>

            <div class="form-section" id="supersets">
                <label>Supersets Well With:</label>
                <input type="text" name="supersets_well_with[]">
                <button type="button" onclick="addTagInput('supersets', 'supersets_well_with[]')">+ Add</button>
            </div>

            <div class="form-section">
                <button type="submit">Add Exercise</button>
            </div>
            <div id="form-status" style="margin-top: 10px;"></div>
        </form>
    </div>
</body>

</html>